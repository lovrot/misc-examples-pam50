---
title: "Example: PAM50 intrinsic subtypes in the Mainz dataset"
author: "John LÃ¶vrot"
license: "CC BY 4.0"
date: "`r format(Sys.Date(), format = '%B %d, %Y')`"
output: 
  html_document:
    theme: cosmo
    toc: true
    toc_float: true
    fig_width: 8
    fig_height: 4
link-citations: yes
bibliography: bibliography.bib
csl: journal-of-the-national-cancer-institute.csl
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.path = 'graphics/example-pam50-in-mainz-', 
    echo = FALSE, warning = FALSE, message = FALSE)
```

```{r load_project}
setwd("..")
ProjectTemplate::reload.project(list(data_loading = FALSE, munging = FALSE, 
    cache_loading = TRUE))  # during development
# ProjectTemplate::reload.project()
setwd("reports")
```

```{r settings}
ggplot2::theme_set(theme_classic() +
    theme(axis.line.x = element_blank()) + 
    theme(axis.line.y = element_blank()))

col4 <- rev(RColorBrewer::brewer.pal(4, "RdYlBu"))
names(col4) <- paste0("Q", 1:4)
```

```{r, additional_munging}
mainz$trigrp <- with(pData(mainz), factor(
  ifelse(erstat %in% "ER+" & !(subtypecd %in% "H2"), "ER+/not H2", 
    ifelse(erstat %in% "ER-" & !(subtypecd %in% "H2"), "ER-/not H2", 
      ifelse(subtypecd %in% "H2", "H2", NA))), 
  levels = c("ER+/not H2", "H2", "ER-/not H2")))
```

# Introduction

The aim of these analysis notes is to give a basic introduction to PAM50 intrinsic subtypes and risk of reccurence score [@Parker2009] using a published breast cancer dataset. 
These notes are generated using an R code bundle available at [github](http://github.com/lovrot/misc-examples-pam50), and the aim of this bundle is also to show how one can use the [ProjectTemplate](http://projecttemplate.net/) framework for a data analysis project. 

# The Mainz dataset

In these notes, we use the Mainz cohort [@Schmidt2008] of primary breast cancer patients. It is a population based cohort. Lymph node negative disease, no adjuvant therapy.

Gene-expression and clinical-pathological data was retrieved from the Gene Expression Omnibus (GEO) at NCBI (accession [GSE11121](http://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE11121)) using the R/Bioconductor package [GEOquery](http://bioconductor.org/packages/GEOquery/). Additionally, the oestrogen receptor status was retrieve from the R/Bioconductor data package [breastCancerMAINZ](http://bioconductor.org/packages/breastCancerMAINZ/).

# Initial data explorations

```{r}
eset <- genefilter::nsFilter(mainz, var.cutoff = 0.8)$eset

## Gene-center data using the median
exprs(eset) <- sweep(exprs(eset), 1, apply(exprs(eset), 1, "median"))
```

```{r}
data("pam50", package = "genefu")
eset50 <- mainz[fData(mainz)$entrezid %in% pam50$centroids.map$EntrezGene.ID, ]
eset50 <- genefilter::featureFilter(eset50)
featureNames(eset50) <- fData(eset50)$symbol

## Gene-center data using the median
exprs(eset50) <- sweep(exprs(eset50), 1, apply(exprs(eset50), 1, "median"))
```

## Clinical-pathological characteristics

```{r tab1}
## Adopted from http://stackoverflow.com/a/29953844
tmp_df <- pData(mainz)[, c("tumsize", "lnstat", "erstat", "histgr", "subtypecd")]
names(tmp_df) <- c("Tumour size (cm)", "Nodal status", "ER status", "Tumour grade", "Intrinsic subtype")
out <- knitr::kable(summary(tmp_df,  digits = 2), 
  caption = "Table. Clinial-pathological characteristics of the Mainz cohort. ER: Oestrogen receptor; LA: Luminal A; LB: Luminal B; H2: HER2-enriched; LB: Basal-like; NBL: Normal breast-like.")
gsub('NA', '  ', out)
```

## t-SNE plots

t-distributed stochastic neighbour embedding (t-SNE) plots.

```{r}
set.seed(20101216)
x <- t(exprs(eset))
d <- dis_cor(x, method = "spearman")  # although, not strict distance metric
tsne_mainz <- Rtsne(d, theta = 0)
## theta = 0: exact t-SNE
## perplexity: "This value effectively controls how many nearest neighbours are taken into account when constructing the embedding in the low-dimensional space"

eset$tsne1 <- tsne_mainz$Y[, 1]
eset$tsne2 <- tsne_mainz$Y[, 2]
```

```{r}
set.seed(20101216)
x <- t(exprs(eset50))
d <- dis_cor(x, method = "spearman")
tsne_mainz50 <- Rtsne(d, theta = 0)

eset50$tsne1 <- tsne_mainz50$Y[, 1]
eset50$tsne2 <- tsne_mainz50$Y[, 2]
```

```{r fig_tsne, fig.height = 4.5, fig.cap = "Figure. t-SNE plots of median-centered data and using one minus Spearman's correlation dissimilarity metric. (A) After non-specific filtering keeping top 20\\% most varying genes, and (B) based on the fifty PAM50 genes. t-SNE: t-distributed stochastic neighbour embedding."}
gg1 <- ggplot(data = pData(eset), 
  aes(x = tsne1, y = tsne2, col = subtypecd)) +
  geom_point() +
  scale_colour_manual(values = colCGANsubtypecd, guide = FALSE) +
  coord_equal() +
  labs(x = "t-SNE 1", y = "t-SNE 2")

gg2 <- ggplot(data = pData(eset50), 
  aes(x = tsne1, y = tsne2, col = subtypecd)) +
  geom_point() +
  scale_colour_manual(values = colCGANsubtypecd) +
  coord_equal() +
  labs(x = "t-SNE 1", y = "t-SNE 2", col = "Subtype")

cowplot::plot_grid(gg1, gg2, labels = "AUTO", rel_widths = c(1, 1.25))
```

## Illustrative cluster heatmap

```{r fig_heatmap, fig.height = 9, fig.cap = "Figure. Semi-unsupervised clustering of the Mainz patients based on the PAM50 genes. Average-linkage hierarchical clustering using a one-minus-spearman rank correlation dissimilarity metric, after gene-centering using the median. Yellow: higher than median gene expression; black: median; blue: lower than median. PAM50PROLIF: PAM50 proliferation index."}
par(bty = "n")

fData(eset50)$PAM50PROLIF <- fData(eset50)$entrezid %in% Nielsen10CCRTabS1$entrezid

fig <- annHeatmap2(
  exprs(eset50),
  dendrogram = list(
    Col = list(clustfun = hclust_avl, distfun = dis_cor, status = "yes", lwd = 1), 
    Row = list(clustfun = hclust_avl, distfun = dis_cor, status = "hide")), 
  annotation = list(
    Col = list(data = pData(eset50)[, c("erstat", "PAM50PROLIF", "subtypecd")], 
      inclRef = TRUE), 
    Row = list(data = fData(eset50)[, "PAM50PROLIF", drop = FALSE], 
      inclRef = FALSE)), 
  labels = list(
    Col = list(labels = NULL),
    Row = list(cex = 0.75)),
  breaks = atanbreaks(eset50, trg = 4),
  col = cyanblackyellow,
  legend = TRUE, 
  scale = "none")
plot(fig, widths = c(0.75, 5, 0.5), heights = c(1.5, 5, 2))
```

# Assocations with outcome

Since the Mainz dataset is a cohort of patients not receiving systemic therapy after surgery, the associations with outcome we observe are pure prognostic. [@Ballman2015] A biomarker can of course also be both prognostic and therapy predictive. An example is HER2 status.

## Illustration of excess distant metastases plots

The association between the PAM50 proliferation index and outcome is illustrated using exploratory plots of excess distant metastases. 
A smoother with exploratory confidence band is superimposed in the scatterplot and the contributions from individual patients are shown with circles. 
The shape of the smoother indicates the form of an association between the index and risk of distant metastasis. 
Mathematically, the excess distant metastases are martingale residuals in a null Cox model. 
Corresponding plots for PAM50 intrinsic subtypes are added for comparison.

```{r fig_excessdm1, fig.cap = "Figure. Excess distant metastases in relation to PAM50 (A) intrinsic subtype and (B) proliferation index."}
ylim0 <- range(mainz$excessdm)

gg1 <- ggplot(data = pData(mainz), aes(x = PAM50PROLIF, y = excessdm)) + 
  geom_point(shape = 1, aes(col = cat4(PAM50PROLIF))) + 
  geom_smooth(method = "loess", span = 0.75, col = "darkgrey") +
  ylim(ylim0) +
  scale_colour_manual(values = col4, guide = FALSE) + 
  labs(x = "Proliferation index", y = "Excess distant metastases")

gg2 <- ggplot(data = pData(mainz), aes(x = subtypecd, y = excessdm)) + 
  geom_point(shape = 1, position = position_jitter(w = 0.1, h = 0)) + 
  stat_summary(fun.data = "mean_cl_normal", size = 1, aes(col = subtypecd)) +
  scale_colour_manual(values = colCGANsubtypecd, guide = FALSE) + 
  labs(x = "Intrinsic subtype", y = "Excess distant metastases")

cowplot::plot_grid(gg1, gg2, labels = "AUTO", nrow = 1)
```

```{r fig_km, fig.width = 9, fig.height = 6, fig.cap = "Figure. Corresponding Kaplan-Meier curves. The PAM50 proliferation index is categorised into quarters."}
layout(matrix(1:2, nrow = 1, byrow = TRUE))
par(bty = "n")

survplot(Surv(survdmtm/365.25*12, dmstat) ~ cat4(PAM50PROLIF), 
  data = pData(mainz), 
  col = col4, lwd = 1, xmax = 7, 
  stitle = "Proliferation index",
  xlab = "Time (years)", ylab = "Distant metastasis-free survival")
title(main = "A", adj = 0)

survplot(Surv(survdmtm/365.25*12, dmstat) ~ subtypecd, 
  data = pData(mainz), 
  col = colCGANsubtypecd[levels(mainz$subtypecd)], lwd = 1, xmax = 7, 
  stitle = "Intrinsic subtype",
  xlab = "Time (years)", ylab = "Distant metastasis-free survival")
title(main = "B", adj = 0)
```

## Proliferation, intrinsic subtypes and outcome

See, for example, section "Prognostic Signatures Within Intrinsic Subtypes" of the review by Ades et al. [@Ades2014]

```{r fig_excessdm2, fig.height = 10, fig.cap = "Figure. Proliferation, intrinsic subtypes and outcome."}
ylim0 <- range(mainz$excessdm)

gg1 <- ggplot(data = pData(mainz), aes(x = PAM50PROLIF, y = excessdm)) + 
  geom_point(shape = 1) + 
  geom_smooth(method = "loess", span = 0.75, col = "darkgrey") +
  ylim(ylim0) +
  labs(x = "Proliferation index", y = "Excess distant metastases")

gg2 <- ggplot(data = pData(mainz), aes(x = subtypecd, y = PAM50PROLIF)) + 
  geom_boxplot(aes(fill = subtypecd), outlier.colour = "transparent") + 
  geom_point(shape = 1, position = position_jitter(w = 0.2, h = 0)) + 
  scale_x_discrete(limits = rev(levels(mainz$subtypecd))) +
  scale_fill_manual(values = colCGANsubtypecd, guide = FALSE) + 
  labs(x = "Intrinsic subtype", y = "Proliferation index") + 
  coord_flip()

gg3 <- ggplot(data = pData(mainz), aes(x = PAM50PROLIF, y = excessdm)) + 
  geom_point(shape = 1) + 
  geom_smooth(method = "lm", aes(col = subtypecd)) +
  ylim(ylim0) +
  facet_wrap(~ subtype, as.table = FALSE) +
  scale_colour_manual(values = colCGANsubtypecd, guide = FALSE) + 
  labs(x = "Proliferation index", y = "Excess distant metastases")

cowplot::ggdraw() +
  cowplot::draw_plot(gg1, 0, 2/3, 1/2, 1/3) +
  cowplot::draw_plot(gg2, 1/2, 2/3, 1/2, 1/3) +
  cowplot::draw_plot(gg3, 0, 0, 1, 2/3 - 0.05) +
  cowplot::draw_plot_label(c("A", "B", "C"), 
    x = c(0, 1/2, 0), y = c(1, 1, 2/3 - 0.05)) + 
  NULL
```

## Added value of ROR score in ER+ patients

One should judge a candidate biomarker by its ability to improve prognostic/predictive accuracy beyond known prognosicators/predictors. [@Kattan2003]

Initial exploratory plots:

```{r fig_excessdm3, fig.height = 8, fig.cap = "Figure. Excess distant metastases in relation to (upper row) Nottingham prognostic index and (lower row) PAM50 risk of reccurence score in (left column) ER+ patients and (right column) ER+/not H2 patients. NPI: Nottingham prognostic index (based on tumour size, lymph node status and histological grade); RORS: Risk of reccurence score (subtype alone)."}
ylim0 <- range(mainz$excessdm)

gg1 <- ggplot(
  data = subset(pData(mainz), erstat %in% "ER+"), 
  aes(x = NPI, y = excessdm)) + 
  geom_point(shape = 1) + 
  geom_smooth(method = "loess", span = 1, col = "darkred") +
  #facet_grid(. ~ erstat) +
  ylim(ylim0) +
  labs(y = "Excess distant metastases")

gg2 <- ggplot(
  data = subset(pData(mainz), trigrp %in% "ER+/not H2"), 
  aes(x = NPI, y = excessdm)) + 
  geom_point(shape = 1) + 
  geom_smooth(method = "loess", span = 1, col = "darkred") +
  #facet_grid(. ~ trigrp) +
  ylim(ylim0) +
  labs(y = "Excess distant metastases")

gg3 <- ggplot(
  data = subset(pData(mainz), erstat %in% "ER+"), 
  aes(x = RORS, y = excessdm)) + 
  geom_point(shape = 1) + 
  geom_smooth(method = "loess", col = "darkred") +
  #facet_grid(. ~ erstat) +
  ylim(ylim0) +
  labs(y = "Excess distant metastases")

gg4 <- ggplot(
  data = subset(pData(mainz), trigrp %in% "ER+/not H2"), 
  aes(x = RORS, y = excessdm)) + 
  geom_point(shape = 1) + 
  geom_smooth(method = "loess", col = "darkred") +
  #facet_grid(. ~ trigrp) +
  ylim(ylim0) +
  labs(y = "Excess distant metastases")

cowplot::plot_grid(gg1, gg2, gg3, gg4, 
  labels = "AUTO", nrow = 2)
```

Formal statistical inference, compare with, for example, Dowsett et al. [@Dowsett2013]:

```{r}
model1a <- coxph(Surv(survdmtm, dmstat) ~ NPI, 
  data = subset(pData(mainz), erstat %in% "ER+"))
model2a <- coxph(Surv(survdmtm, dmstat) ~ RORS, 
  data = subset(pData(mainz), erstat %in% "ER+"))
model3a <- coxph(Surv(survdmtm, dmstat) ~ NPI + RORS, 
  data = subset(pData(mainz), erstat %in% "ER+"))

model1b <- coxph(Surv(survdmtm, dmstat) ~ NPI, 
  data = subset(pData(mainz), trigrp %in% "ER+/not H2"))
model2b <- coxph(Surv(survdmtm, dmstat) ~ RORS, 
  data = subset(pData(mainz), trigrp %in% "ER+/not H2"))
model3b <- coxph(Surv(survdmtm, dmstat) ~ NPI + RORS, 
  data = subset(pData(mainz), trigrp %in% "ER+/not H2"))

## Concordance index (C-index)
cindex_df <- data.frame(
  subpop = factor(rep(c("ER+", "ER+/not H2"), each = 3), 
    levels = c("ER+", "ER+/not H2")), 
  marker = factor(rep(c("NPI", "RORS", "NPI+RORS"), times = 2), 
    levels = c("NPI", "RORS", "NPI+RORS")), 
  cindex = c(
    summary(model1a)$concordance["C"], 
    summary(model2a)$concordance["C"], 
    summary(model3a)$concordance["C"],
    summary(model1b)$concordance["C"], 
    summary(model2b)$concordance["C"], 
    summary(model3b)$concordance["C"]))

## Likelihood ratio tests
lr_test_df <- rbind(
  cbind(
    data.frame(
      Population = c("ER+"), 
      Comparison = "NPI+RORS vs NPI"), 
    as.data.frame(anova(model1a, model3a)[2, 2:4])),
  cbind(
    data.frame(
      Population = c("ER+"), 
      Comparison = "NPI+RORS vs RORS"), 
    as.data.frame(anova(model2a, model3a)[2, 2:4])), 
  cbind(
    data.frame(
      Population = c("ER+/not H2"), 
      Comparison = "NPI+RORS vs NPI"), 
    as.data.frame(anova(model1b, model3b)[2, 2:4])),
  cbind(
    data.frame(
      Population = c("ER+/not H2"), 
      Comparison = "NPI+RORS vs RORS"), 
    as.data.frame(anova(model2b, model3b)[2, 2:4]))) 
```

```{r fig_cidx, fig.cap = "Figure. Concordance indices to assess the added value of ROR-S beyond standard clinical-pathological prognosticators as represented by the Nottingham prognostic index (NPI) in (A) ER+ patients and (B) ER+/not H2 patients."}
colmarker <- colJCO[c("blue", "yellow", "red")]
names(colmarker) <- c("NPI", "RORS", "NPI+RORS")

gg1 <- ggplot(data = subset(cindex_df, subpop  ==  "ER+"), 
  aes(x = marker, y = cindex, fill = marker)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_cartesian(ylim = c(0.5, 0.8)) +
  #facet_grid(. ~ subpop) +
  scale_fill_manual(values = colmarker, guide = FALSE) +
  labs(x = "", y = "C index")

gg2 <- ggplot(data = subset(cindex_df, subpop  ==  "ER+/not H2"), 
  aes(x = marker, y = cindex, fill = marker)) +
  geom_bar(stat = "identity", position = "dodge") +
  coord_cartesian(ylim = c(0.5, 0.8)) +
  #facet_grid(. ~ subpop) +
  scale_fill_manual(values = colmarker, guide = FALSE) +
  labs(x = "", y = "C index")

cowplot::plot_grid(gg1, gg2, labels = "AUTO", nrow = 1)
```

```{r tab2}
knitr::kable(lr_test_df, digits = 3, row.names = FALSE, 
  caption = "Table. Likelihood ratio tests to assess the added value of ROR-S beyond NPI in the sub-populations ER+ patients and ER+/not H2 patients. Corresponding tests to assess the added value of NPI beyond ROR-S is also included for comparison.")
```

# R session information

```{r}
print(sessionInfo(), locale = FALSE)
```

- - -

Copyright &copy; 2015-2017 by John LÃ¶vrot.
This work is licensed under a [Creative Commons Attribution 4.0 International License](http://creativecommons.org/licenses/by/4.0/).  
The source code is available at [github.com/lovrot/misc-examples-pam50](http://github.com/lovrot/misc-examples-pam50).  
Version `r format(read.dcf("../description.dcf")[1, "version"])`

- - -

# References
